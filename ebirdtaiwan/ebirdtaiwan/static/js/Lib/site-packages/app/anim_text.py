from browser import document, html, window, timer
import browser
import time


anim_region = document["anim_region"]
sentence0 = html.DIV()
sentence1 = html.DIV()
sentence2 = html.DIV()


T0 = '202020202020'
T1 = 'EBIRD TAIWAN'
T2 = 'FALL CHALLENGE'

string_seq = list(' ABCDEFGHIJKLMNOPQRSTUVWXYZ')
num_seq = list('012')
T0_delays = [0]
changing_text_delay = 60

for s in T0:
    T0_delays.append(num_seq.index(s)+T0_delays[-1])
T1_delays = [0]
for s in T1:
    T1_delays.append(string_seq.index(s)+T1_delays[-1])
T2_delays = [0]
for s in T2:
    T2_delays.append(string_seq.index(s)+T2_delays[-1])


for i in range(24):    
    if i%2 == 0:
        sentence0 <= html.DIV('2', Class = 'anim_letter odd_letter')
        sentence1 <= html.DIV('2', Class = 'anim_letter odd_letter')
        sentence2 <= html.DIV('2', Class = 'anim_letter odd_letter')
    else:
        sentence0 <= html.DIV('0', Class = 'anim_letter even_letter')
        sentence1 <= html.DIV('0', Class = 'anim_letter even_letter')
        sentence2 <= html.DIV('0', Class = 'anim_letter even_letter')

anim_region<=sentence0
anim_region<=sentence1
anim_region<=sentence2


def change_text():
    pass

rt = 0 #real tick
dt = 0 #delta time
run = None
ch = 0

s0_letter_index = 0
s1_letter_index = 0
s2_letter_index = 0

s0_seq_index = 0
s1_seq_index = 0
s2_seq_index = 0

'''
unit of dt is fps (it is about 60 fps)
'''
def render():

    global rt
    global dt
    global ch
    global s0_letter_index
    global s1_letter_index
    global s2_letter_index
    global s0_seq_index
    global s1_seq_index
    global s2_seq_index

    rt += 1
    if rt%2 == 1:
        dt += 1
        if dt % 30 == 0:
            for e in document.select('div.odd_letter'):
                e.style.transition='transform 0.5s ease-in-out'
                e.style.transform='translateY(-30px)'
                e.text = list('20')[ch%2]
            for e in document.select('div.even_letter'):
                e.text = list('20')[ch%2-1]        
            ch += 1  

        if dt % 30 == 29:
            for e in document.select('div.odd_letter'):
                e.style.transform='translateY(0px)'
                e.style.transition='none'
                # e.text = list('20')[ch%2]

        if dt % 30 == 10:
            for e in document.select('div.even_letter'):
                e.style.transition='transform 0.5s ease-in-out'
                e.style.transform='translateY(-30px)'        

        if dt % 30 == 9:
            for e in document.select('div.even_letter'):
                e.style.transform='translateY(0px)'
                e.style.transition='none'
                # e.text = list('20')[ch%2]    

        if (dt - changing_text_delay > T0_delays[s0_letter_index] and s0_letter_index<len(T0)):
            s0_target_letter = sentence0.children[s0_letter_index]
            if s0_seq_index == 0:
                s0_target_letter.attrs['class'] = 'anim_changing_letter'
                s0_target_letter.style.transition='none'
                s0_target_letter.style.transform = 'translateY(0px)'
            s0_target_letter.text = num_seq[s0_seq_index]
            s0_seq_index +=1
            if num_seq[s0_seq_index-1] == T0[s0_letter_index]:
                s0_seq_index = 0
                s0_letter_index += 1

        if (dt - changing_text_delay > T1_delays[s1_letter_index] and s1_letter_index<len(T1)):
            s1_target_letter = sentence1.children[s1_letter_index]
            if s1_seq_index == 0:
                s1_target_letter.attrs['class'] = 'anim_changing_letter'
                s1_target_letter.style.transition='none'
                s1_target_letter.style.transform = 'translateY(0px)'
            s1_target_letter.text = string_seq[s1_seq_index]
            s1_seq_index +=1
            if string_seq[s1_seq_index-1] == T1[s1_letter_index]:
                s1_seq_index = 0
                s1_letter_index += 1

        if (dt - changing_text_delay > T2_delays[s2_letter_index] and s2_letter_index<len(T2)):
            s2_target_letter = sentence2.children[s2_letter_index]
            if s2_seq_index == 0:
                s2_target_letter.attrs['class'] = 'anim_changing_letter'
                s2_target_letter.style.transition='none'
                s2_target_letter.style.transform = 'translateY(0px)'
            s2_target_letter.text = string_seq[s2_seq_index]
            s2_seq_index +=1
            if string_seq[s2_seq_index-1] == T2[s2_letter_index]:
                s2_seq_index = 0
                s2_letter_index += 1

        

def animloop(t):
    global run
    run = window.requestAnimationFrame(animloop)
    render()

def cancel_anim():
    global run
    window.cancelAnimationFrame(run)
    run = None
    for e in document.select('div.anim_letter'):
        e.style.transition='none'
        e.style.transform='translateY(0px)'
        if 'odd_letter' in e.attrs['class']:
            e.text='2'
        if 'even_letter' in e.attrs['class']:
            e.text='0'

    print('anim_stopped')
'''
unit of timer is 1 ms (1000 = 1s)
'''
def start_anim(event):
    animloop(1)
    timer.set_timeout(cancel_anim, 6000)        

document<=html.DIV(id='hidden_trigger')
document['hidden_trigger'].bind('click', start_anim)
document['hidden_trigger'].click()
