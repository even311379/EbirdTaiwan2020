from browser import document, html, window, timer
import browser
import time
import random

anim_region = document["anim_region"]
sentence_bg = html.DIV(Class='sentence_region',style={"z-index":"-1","top":"-6rem"})
sentence0 = html.DIV(Class='sentence_region',style={"z-index":"-2"})
sentence1 = html.DIV(Class='sentence_region',style={"z-index":"-3","top":"6rem"})
sentence2 = html.DIV(Class='sentence_region',style={"z-index":"-4","top":"12rem"})

T0 = '202020202020'
T1 = 'EBIRD TAIWAN'
T2 = 'AUTUMN CHALLENGE'

string_seq = list(' ABCDEFGHIJKLMNOPQRSTUVWXYZ')
num_seq = list('012')
T0_delays = [0]
changing_text_delay = 45

for s in T0:
    T0_delays.append(num_seq.index(s)+T0_delays[-1])
T1_delays = [0]
for s in T1:
    T1_delays.append(string_seq.index(s)+T1_delays[-1])
T2_delays = [0]
for s in T2:
    T2_delays.append(string_seq.index(s)+T2_delays[-1])


for i in range(24):    
    if i%2 == 0:
        sentence0 <= html.DIV('2', Class = 'anim_letter odd_letter', style={"left":f"{i*5}rem"})
        sentence1 <= html.DIV('2', Class = 'anim_letter odd_letter', style={"left":f"{i*5}rem",})
        sentence2 <= html.DIV('2', Class = 'anim_letter odd_letter', style={"left":f"{i*5}rem",})        
    else:
        sentence0 <= html.DIV('0', Class = 'anim_letter even_letter', style={"left":f"{i*5}rem"})
        sentence1 <= html.DIV('0', Class = 'anim_letter even_letter', style={"left":f"{i*5}rem",})
        sentence2 <= html.DIV('0', Class = 'anim_letter even_letter', style={"left":f"{i*5}rem",})        

anim_region<=sentence_bg
anim_region<=sentence0
anim_region<=sentence1
anim_region<=sentence2
# anim_region<=html.DIV(Class='sentence_region',style={"z-index":"0","top":"-6rem"})

def change_text():
    pass

rt = 0 #real tick
dt = 0 #delta time
run = None
ch = 0

s0_letter_index = 0
s1_letter_index = 0
s2_letter_index = 0

s0_seq_index = 0
s1_seq_index = 0
s2_seq_index = 0


'''
unit of dt is fps (it is about 60 fps)
'''
'''
def render():

    global rt
    global dt
    global ch
    global s0_letter_index
    global s1_letter_index
    global s2_letter_index
    global s0_seq_index
    global s1_seq_index
    global s2_seq_index


    dt += 1
    if dt % 30 == 0:
        for e in document.select('div.odd_letter'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-3rem)'
            e.text = list('20')[ch%2]
        for e in document.select('div.even_letter'):
            e.text = list('20')[ch%2-1]        
        ch += 1  

    if dt % 30 == 29:
        for e in document.select('div.odd_letter'):
            e.style.transform='translateY(0px)'
            e.style.transition='none'
            # e.text = list('20')[ch%2]

    if dt % 30 == 10:
        for e in document.select('div.even_letter'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-3rem)'        

    if dt % 30 == 9:
        for e in document.select('div.even_letter'):
            e.style.transform='translateY(0px)'
            e.style.transition='none'
            # e.text = list('20')[ch%2]    

    if (dt - changing_text_delay > T0_delays[s0_letter_index] and s0_letter_index<len(T0)):
        s0_target_letter = sentence0.children[s0_letter_index]
        if s0_seq_index == 0:
            s0_target_letter.attrs['class'] = 'anim_changing_letter'
            s0_target_letter.style.transition='none'
            s0_target_letter.style.transform = 'translateY(0px)'
        s0_target_letter.text = num_seq[s0_seq_index]
        s0_seq_index +=1
        if num_seq[s0_seq_index-1] == T0[s0_letter_index]:
            s0_seq_index = 0
            s0_letter_index += 1

    if (dt - changing_text_delay > T1_delays[s1_letter_index] and s1_letter_index<len(T1)):
        s1_target_letter = sentence1.children[s1_letter_index]
        if s1_seq_index == 0:
            s1_target_letter.attrs['class'] = 'anim_changing_letter'
            s1_target_letter.style.transition='none'
            s1_target_letter.style.transform = 'translateY(0px)'
        s1_target_letter.text = string_seq[s1_seq_index]
        s1_seq_index +=1
        if string_seq[s1_seq_index-1] == T1[s1_letter_index]:
            s1_seq_index = 0
            s1_letter_index += 1

    if (dt - changing_text_delay > T2_delays[s2_letter_index] and s2_letter_index<len(T2)):
        s2_target_letter = sentence2.children[s2_letter_index]
        if s2_seq_index == 0:
            s2_target_letter.attrs['class'] = 'anim_changing_letter'
            s2_target_letter.style.transition='none'
            s2_target_letter.style.transform = 'translateY(0px)'
        s2_target_letter.text = string_seq[s2_seq_index]
        s2_seq_index +=1
        if string_seq[s2_seq_index-1] == T2[s2_letter_index]:
            s2_seq_index = 0
            s2_letter_index += 1

'''

# try random timing transition
for e in document.select('div.anim_letter'):
    e.attrs['class'] += f' G{random.randint(1,5)}'
    # eval(f'G{random.randint(1,5)}.append(e)')

allow_change_20 = True

'''
move for 24f, stay 6s, and another loop
'''

def render():
    global rt
    global dt
    global ch
    global s0_letter_index
    global s1_letter_index
    global s2_letter_index
    global s0_seq_index
    global s1_seq_index
    global s2_seq_index

    global allow_change_20

    dt += 1
    # for g in range(1,5):
    #     d = 6*g
    #     h = g+1
    #     chmod = 0
    #     if g==5: 
    #         d = 0
    #         h = 1
    #     if g%2== 0: chmod = 1
    #     if dt % 30 == d:
    #         for e in document.select(f'div.G{g}'):
    #             e.style.transition='transform 0.3s ease-in-out'
    #             e.style.transform='translateY(-2rem)'
    #         for e in document.select(f'div.G{h}'):
    #             e.style.transition='none'
    #             e.style.transform='translateY(0)'
    #             if allow_change_20: e.text = list('20')[(ch+chmod)%2]

    # if dt%30==0: ch+=1

    if dt % 30 == 6:
        for e in document.select('div.G1'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G2'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[ch%2]
    if dt % 30 == 12:
        for e in document.select('div.G2'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G3'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[(ch+1)%2]

    if dt % 30 == 18:
        for e in document.select('div.G3'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G4'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[ch%2]

    if dt % 30 == 24:
        for e in document.select('div.G4'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G5'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[(ch+1)%2]

    if dt % 30 == 0:
        for e in document.select('div.G5'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G1'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[ch%2]
        ch+=1

    if (dt - changing_text_delay > T0_delays[s0_letter_index] and s0_letter_index<len(T0)):
        s0_target_letter = sentence0.children[s0_letter_index]
        if s0_seq_index == 0:
            s0_target_letter.attrs['class'] = 'anim_changing_letter'
            s0_target_letter.style.transition='none'
            s0_target_letter.style.transform = 'translateY(0px)'
        s0_target_letter.text = num_seq[s0_seq_index]
        s0_seq_index +=1
        if num_seq[s0_seq_index-1] == T0[s0_letter_index]:
            s0_seq_index = 0
            s0_letter_index += 1

    if (dt - changing_text_delay > T1_delays[s1_letter_index] and s1_letter_index<len(T1)):
        s1_target_letter = sentence1.children[s1_letter_index]
        if s1_seq_index == 0:
            s1_target_letter.attrs['class'] = 'anim_changing_letter'
            s1_target_letter.style.transition='none'
            s1_target_letter.style.transform = 'translateY(0px)'
        s1_target_letter.text = string_seq[s1_seq_index]
        s1_seq_index +=1
        if string_seq[s1_seq_index-1] == T1[s1_letter_index]:
            s1_seq_index = 0
            s1_letter_index += 1

    if (dt - changing_text_delay > T2_delays[s2_letter_index] and s2_letter_index<len(T2)):
        s2_target_letter = sentence2.children[s2_letter_index]
        if s2_seq_index == 0:
            s2_target_letter.attrs['class'] = 'anim_changing_letter'
            s2_target_letter.style.transition='none'
            s2_target_letter.style.transform = 'translateY(0px)'
        s2_target_letter.text = string_seq[s2_seq_index]
        s2_seq_index +=1
        if string_seq[s2_seq_index-1] == T2[s2_letter_index]:
            s2_seq_index = 0
            s2_letter_index += 1
        

def animloop(t):
    global run
    run = window.requestAnimationFrame(animloop)
    render()

def cancel_anim():
    global run
    window.cancelAnimationFrame(run)
    run = None
    for e in document.select('div.anim_letter'):
        e.style.transition='none'
        e.style.transform='translateY(0px)'
        if 'odd_letter' in e.attrs['class']:
            e.text='2'
        if 'even_letter' in e.attrs['class']:
            e.text='0'
    # sentence3.style.display="none"
    print('anim_stopped')

def reset_20():
    global allow_change_20
    allow_change_20=False
    for e in document.select('div.anim_letter'):
        e.style.transition='none'
        e.style.transform='translateY(0px)'
        if 'odd_letter' in e.attrs['class']:
            e.text='2'
        if 'even_letter' in e.attrs['class']:
            e.text='0'


'''
unit of timer is 1 ms (1000 = 1s)
'''
def start_anim(event):
    animloop(1)
    timer.set_timeout(cancel_anim, 4800)
    timer.set_timeout(reset_20, 4750)        

document<=html.DIV(id='hidden_trigger', style={'display':'none'})
document['hidden_trigger'].bind('click', start_anim)
document['hidden_trigger'].click()


'''
team icon click events
'''
document<=html.DIV(id='team1_screen')
document['team1_screen']<=html.H1('第一隊的報名頁面在這裡喔！',Class='team_screen_title')

def team1_icon_frame1():
    document['team1_icon'].style.transition = 'transition: transform 1s ease-in-out'
    document['team1_icon'].style.transform = 'translate(-20vw, -30vh)'

def team1_icon_frame2():
    document['team1_icon'].style.transition = 'transition: transform 2s ease-in-out'
    document['team1_icon'].style.transform = 'translate(-40vw, 5vh)'

def team1_icon_frame3():
    document['team1_icon'].style.transition = 'transition: transform 0.5s ease-in-out'
    document['team1_icon'].style.transform = 'translate(60vw, -90vh)'

def show_team1_screen():
    document['team1_screen'].style.top = 0;
    document['team1_screen'].style.right = 0;

def team1_icon_back():
    document['team1_icon'].style.transform = 'translate(0vw, 0vh)'
    document['team1_icon'].bind('click', pull_screen1)

def pull_screen1(ev):
    print('hey!!')
    document['team1_icon'].unbind('click', pull_screen1)
    team1_icon_frame1()
    timer.set_timeout(team1_icon_frame2, 1000)
    timer.set_timeout(team1_icon_frame3, 3000)
    timer.set_timeout(show_team1_screen, 2900)    
    

document['team1_icon'].bind('click', pull_screen1)