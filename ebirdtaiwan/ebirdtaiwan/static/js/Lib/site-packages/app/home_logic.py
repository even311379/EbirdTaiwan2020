from browser import document, html, window, timer, bind
import browser
import time
import random


'''
***********************************************
**************   anim text effect  ************
***********************************************
'''
anim_region = document["anim_region"]
sentence_bg = html.DIV(Class='sentence_region',style={"z-index":"-1","top":"-6rem"})
sentence0 = html.DIV(Class='sentence_region',style={"z-index":"-2"})
sentence1 = html.DIV(Class='sentence_region',style={"z-index":"-3","top":"6rem"})
sentence2 = html.DIV(Class='sentence_region',style={"z-index":"-4","top":"12rem"})

T0 = '202020202020'
T1 = 'EBIRD TAIWAN'
T2 = 'AUTUMN CHALLENGE'

string_seq = list(' ABCDEFGHIJKLMNOPQRSTUVWXYZ')
num_seq = list('012')
T0_delays = [0]
changing_text_delay = 45

for s in T0:
    T0_delays.append(num_seq.index(s)+T0_delays[-1])
T1_delays = [0]
for s in T1:
    T1_delays.append(string_seq.index(s)+T1_delays[-1])
T2_delays = [0]
for s in T2:
    T2_delays.append(string_seq.index(s)+T2_delays[-1])


for i in range(24):    
    if i%2 == 0:
        sentence0 <= html.DIV('2', Class = 'anim_letter odd_letter', style={"left":f"{i*5}rem"})
        sentence1 <= html.DIV('2', Class = 'anim_letter odd_letter', style={"left":f"{i*5}rem",})
        sentence2 <= html.DIV('2', Class = 'anim_letter odd_letter', style={"left":f"{i*5}rem",})        
    else:
        sentence0 <= html.DIV('0', Class = 'anim_letter even_letter', style={"left":f"{i*5}rem"})
        sentence1 <= html.DIV('0', Class = 'anim_letter even_letter', style={"left":f"{i*5}rem",})
        sentence2 <= html.DIV('0', Class = 'anim_letter even_letter', style={"left":f"{i*5}rem",})        

anim_region<=sentence_bg
anim_region<=sentence0
anim_region<=sentence1
anim_region<=sentence2
# anim_region<=html.DIV(Class='sentence_region',style={"z-index":"0","top":"-6rem"})

def change_text():
    pass

rt = 0 #real tick
dt = 0 #delta time
run = None
ch = 0

s0_letter_index = 0
s1_letter_index = 0
s2_letter_index = 0

s0_seq_index = 0
s1_seq_index = 0
s2_seq_index = 0


'''
randomly assign 5 groups for moving around
'''
# try random timing transition
for e in document.select('div.anim_letter'):
    e.attrs['class'] += f' G{random.randint(1,5)}'
    # eval(f'G{random.randint(1,5)}.append(e)')

allow_change_20 = True

'''
unit of dt is fps (it is about 60 fps)
move for 24f, stay 6s, and another loop
'''

def render():
    global rt
    global dt
    global ch
    global s0_letter_index
    global s1_letter_index
    global s2_letter_index
    global s0_seq_index
    global s1_seq_index
    global s2_seq_index

    global allow_change_20

    dt += 1

    if dt % 30 == 6:
        for e in document.select('div.G1'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G2'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[ch%2]
    if dt % 30 == 12:
        for e in document.select('div.G2'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G3'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[(ch+1)%2]

    if dt % 30 == 18:
        for e in document.select('div.G3'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G4'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[ch%2]

    if dt % 30 == 24:
        for e in document.select('div.G4'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G5'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[(ch+1)%2]

    if dt % 30 == 0:
        for e in document.select('div.G5'):
            e.style.transition='transform 0.3s ease-in-out'
            e.style.transform='translateY(-2rem)'
        for e in document.select('div.G1'):
            e.style.transition='none'
            e.style.transform='translateY(0)'
            if allow_change_20: e.text = list('20')[ch%2]
        ch+=1

    if (dt - changing_text_delay > T0_delays[s0_letter_index] and s0_letter_index<len(T0)):
        s0_target_letter = sentence0.children[s0_letter_index]
        if s0_seq_index == 0:
            s0_target_letter.attrs['class'] = 'anim_changing_letter'
            s0_target_letter.style.transition='none'
            s0_target_letter.style.transform = 'translateY(0px)'
        s0_target_letter.text = num_seq[s0_seq_index]
        s0_seq_index +=1
        if num_seq[s0_seq_index-1] == T0[s0_letter_index]:
            s0_seq_index = 0
            s0_letter_index += 1

    if (dt - changing_text_delay > T1_delays[s1_letter_index] and s1_letter_index<len(T1)):
        s1_target_letter = sentence1.children[s1_letter_index]
        if s1_seq_index == 0:
            s1_target_letter.attrs['class'] = 'anim_changing_letter'
            s1_target_letter.style.transition='none'
            s1_target_letter.style.transform = 'translateY(0px)'
        s1_target_letter.text = string_seq[s1_seq_index]
        s1_seq_index +=1
        if string_seq[s1_seq_index-1] == T1[s1_letter_index]:
            s1_seq_index = 0
            s1_letter_index += 1

    if (dt - changing_text_delay > T2_delays[s2_letter_index] and s2_letter_index<len(T2)):
        s2_target_letter = sentence2.children[s2_letter_index]
        if s2_seq_index == 0:
            s2_target_letter.attrs['class'] = 'anim_changing_letter'
            s2_target_letter.style.transition='none'
            s2_target_letter.style.transform = 'translateY(0px)'
        s2_target_letter.text = string_seq[s2_seq_index]
        s2_seq_index +=1
        if string_seq[s2_seq_index-1] == T2[s2_letter_index]:
            s2_seq_index = 0
            s2_letter_index += 1
        

def animloop(t):
    global run
    run = window.requestAnimationFrame(animloop)
    render()

def cancel_anim():
    global run
    window.cancelAnimationFrame(run)
    run = None
    for e in document.select('div.anim_letter'):
        e.style.transition='none'
        e.style.transform='translateY(0px)'
        if 'odd_letter' in e.attrs['class']:
            e.text='2'
        if 'even_letter' in e.attrs['class']:
            e.text='0'
    # sentence3.style.display="none"
    print('anim_stopped')

def reset_20():
    global allow_change_20
    allow_change_20=False
    for e in document.select('div.anim_letter'):
        e.style.transition='none'
        e.style.transform='translateY(0px)'
        if 'odd_letter' in e.attrs['class']:
            e.text='2'
        if 'even_letter' in e.attrs['class']:
            e.text='0'


'''
unit of timer is 1 ms (1000 = 1s)
'''
def start_anim(event):
    animloop(1)
    timer.set_timeout(cancel_anim, 4800)
    timer.set_timeout(reset_20, 4750)        

document<=html.DIV(id='hidden_trigger', style={'display':'none'})
document['hidden_trigger'].bind('click', start_anim)
document['hidden_trigger'].click()



'''
***********************************************
**************   go for register   ************
***********************************************
'''

'''
team icon click events
'''

def pull_screen1(ev):
    document['team1_screen'].style['transition-delay'] = '1.2s'
    document['team1_icon'].style['animation-name'] = 'icon1_drag_screen'
    document['team1_screen'].style.top = '0'
    document['team1_screen'].style.right = '0'
    for i in range(1, 4):
        exec(f"document['team{i}_icon'].unbind('click', pull_screen{i})")


def pull_screen2(ev):
    document['team2_screen'].style['transition-delay'] = '1.2s'
    document['team2_icon'].style['animation-name'] = 'icon2_drag_screen'
    document['team2_screen'].style.top = '0'
    for i in range(1, 4):
        exec(f"document['team{i}_icon'].unbind('click', pull_screen{i})")

def pull_screen3(ev):
    document['team3_screen'].style['transition-delay'] = '1.2s'
    document['team3_icon'].style['animation-name'] = 'icon3_drag_screen'
    document['team3_screen'].style.top = '0'
    document['team3_screen'].style.left = '0'
    for i in range(1, 4):
        exec(f"document['team{i}_icon'].unbind('click', pull_screen{i})")
    
def back_home1(ev):
    document['team1_screen'].style['transition-delay'] = '0s'
    document['team1_screen'].style.top = '100vh'
    document['team1_screen'].style.right = '100vw'
    document['team1_icon'].style.transform = 'translate(0vw, 0vh)'
    document['team1_icon'].style['animation-name'] = ''
    for i in range(1, 4):
        exec(f"document['team{i}_icon'].bind('click', pull_screen{i})")
    
def back_home2(ev):
    document['team2_screen'].style['transition-delay'] = '0s'
    document['team2_screen'].style.top = '100vh'    
    document['team2_icon'].style.transform = 'translate(0vw, 0vh)'
    document['team2_icon'].style['animation-name'] = ''
    for i in range(1, 4):
        exec(f"document['team{i}_icon'].bind('click', pull_screen{i})")

def back_home3(ev):
    document['team3_screen'].style['transition-delay'] = '0s'
    document['team3_screen'].style.top = '100vh'
    document['team3_screen'].style.left = '100vw'
    document['team3_icon'].style.transform = 'translate(0vw, 0vh)'
    document['team3_icon'].style['animation-name'] = ''
    for i in range(1, 4):
        exec(f"document['team{i}_icon'].bind('click', pull_screen{i})")

for i in range(1, 4):
    code_string = f'''
document['team{i}_icon'].bind('click', pull_screen{i})
document['back_home_icon{i}'].bind('click', back_home{i})

@bind(document['team{i}_icon'], "mouseenter")
def enter_icon{i}(ev):
    document['team{i}_icon'].style.cursor = 'pointer'
    document['team{i}_icon'].style.transform = 'scale(1.2) translateY(-3rem)'
    

@bind(document['team{i}_icon'], "mouseleave")
def leave_icon{i}(ev):
    document['team{i}_icon'].style.cursor = 'default'
    document['team{i}_icon'].style.transform = 'scale(1) translateY(0rem)'
    '''
    exec(code_string)

    

# document['team1_icon'].bind('click', pull_screen1)
# document['team2_icon'].bind('click', pull_screen2)
# document['team3_icon'].bind('click', pull_screen3)

# document['back_home_icon1'].bind('click', back_home1)
# document['back_home_icon2'].bind('click', back_home2)
# document['back_home_icon3'].bind('click', back_home3)